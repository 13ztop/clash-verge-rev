name: Auto Sync from clash-verge-rev/clash-verge-rev

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # [æ‰€æœ‰åŒæ­¥æ­¥éª¤ä¿æŒä¸å˜...]
      
      # è®¾ç½®æ—¶åŒºï¼ˆä¸Šæµ·æ—¶é—´ï¼‰
      - name: Set Shanghai time
        id: set_time
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          CURRENT_TIME_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$CURRENT_TIME_SHORT" >> $GITHUB_ENV

      # è°ƒè¯•æ­¥éª¤ï¼šéªŒè¯Telegramè®¾ç½®
      - name: Verify Telegram Configuration
        run: |
          echo "éªŒè¯Telegramè®¾ç½®..."
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "::error::TELEGRAM_BOT_TOKENæœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "::error::TELEGRAM_CHAT_IDæœªè®¾ç½®"
            exit 1
          fi
          
          echo "Telegramé…ç½®éªŒè¯é€šè¿‡"
          echo "BOT_TOKEN_PART=${secrets.TELEGRAM_BOT_TOKEN:0:4}...${secrets.TELEGRAM_BOT_TOKEN: -4}" >> $GITHUB_ENV
          echo "CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV

      # è°ƒè¯•æ­¥éª¤ï¼šæ£€æŸ¥é€šçŸ¥æ¡ä»¶
      - name: Check Notification Conditions
        id: check_conditions
        run: |
          echo "æ£€æŸ¥é€šçŸ¥æ¡ä»¶..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "${{ steps.commit_push.outputs.commit_msg }}" ]; then
            echo "æœ‰å˜æ›´éœ€è¦é€šçŸ¥"
            echo "should_notify=true" >> $GITHUB_ENV
            echo "notification_type=success" >> $GITHUB_ENV
          elif [ "${{ steps.commit_push.outputs.no_changes_detected }}" = "true" ]; then
            echo "æ— å˜æ›´éœ€è¦é€šçŸ¥"
            echo "should_notify=true" >> $GITHUB_ENV
            echo "notification_type=no_changes" >> $GITHUB_ENV
          else
            echo "æ— é€šçŸ¥æ¡ä»¶æ»¡è¶³"
            echo "should_notify=false" >> $GITHUB_ENV
          fi
          
          # æ£€æŸ¥å¤±è´¥æƒ…å†µ
          if [ "${{ job.status }}" != "success" ]; then
            echo "å·¥ä½œæµå¤±è´¥éœ€è¦é€šçŸ¥"
            echo "should_notify=true" >> $GITHUB_ENV
            echo "notification_type=failure" >> $GITHUB_ENV
          fi
          
          echo "æ¡ä»¶æ£€æŸ¥å®Œæˆ"

      # æµ‹è¯•é€šçŸ¥ï¼ˆæ€»æ˜¯å‘é€ï¼‰
      - name: Test Telegram Notification (Always Send)
        if: ${{ always() }}  # å³ä½¿å¤±è´¥ä¹Ÿå‘é€
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            ğŸ”§ *Clash Verge Rev å·¥ä½œæµæµ‹è¯•é€šçŸ¥*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **å·¥ä½œæµ**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ **è¿è¡Œæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â€¢ **çŠ¶æ€**: ${{ job.status }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â„¹ï¸ è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼ŒéªŒè¯é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸
            â€¢ BOT_TOKEN: ${{ env.BOT_TOKEN_PART }}
            â€¢ CHAT_ID: ${{ env.CHAT_ID }}

      # åŒæ­¥æˆåŠŸé€šçŸ¥
      - name: Notify Telegram on Sync Success
        if: ${{ success() && env.should_notify == 'true' && env.notification_type == 'success' }}
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            ğŸ”„ *Clash Verge Rev åŒæ­¥æˆåŠŸ | ${{ steps.source_version.outputs.commit_date }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“¦ **æºä»“åº“**: [clash-verge-rev/clash-verge-rev@${{ steps.source_version.outputs.commit_hash }}](https://github.com/clash-verge-rev/clash-verge-rev/commit/${{ steps.source_version.outputs.full_hash }})
            ğŸ  **ç›®æ ‡ä»“åº“**: [13ztop/clash-verge-rev@${{ env.TARGET_COMMIT }}](https://github.com/13ztop/clash-verge-rev/commit/${{ github.sha }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **å˜æ›´æ–‡ä»¶**: ${{ steps.commit_push.outputs.changes_count }} ä¸ª
            â€¢ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_protected.outputs.protected_files_count }} ä¸ª
            â€¢ **ç‰ˆæœ¬**: ${{ steps.source_version.outputs.tag }}
            â€¢ **åŒæ­¥æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… ä»“åº“å·²æ›´æ–°
            [æŸ¥çœ‹æäº¤è¯¦æƒ…](https://github.com/13ztop/clash-verge-rev/commit/${{ github.sha }})

      # æ— å˜æ›´é€šçŸ¥
      - name: Notify Telegram on No Changes
        if: ${{ success() && env.should_notify == 'true' && env.notification_type == 'no_changes' }}
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            â„¹ï¸ *Clash Verge Rev æ— å˜æ›´ | ${{ steps.source_version.outputs.commit_date }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“¦ **æºä»“åº“**: [clash-verge-rev/clash-verge-rev@${{ steps.source_version.outputs.commit_hash }}](https://github.com/clash-verge-rev/clash-verge-rev)
            ğŸ  **ç›®æ ‡ä»“åº“**: [13ztop/clash-verge-rev@${{ env.TARGET_COMMIT }}](https://github.com/13ztop/clash-verge-rev)
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_protected.outputs.protected_files_count }} ä¸ª
            â€¢ **å½“å‰ç‰ˆæœ¬**: ${{ steps.source_version.outputs.tag }}
            â€¢ **æ£€æµ‹æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… ä»“åº“å·²æ˜¯æœ€æ–°çŠ¶æ€

      # åŒæ­¥å¤±è´¥é€šçŸ¥
      - name: Notify Telegram on Failure
        if: ${{ failure() && env.should_notify == 'true' && env.notification_type == 'failure' }}
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            â€¼ï¸ *Clash Verge Rev åŒæ­¥å¤±è´¥*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”§ **å·¥ä½œæµ**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â° **å‘ç”Ÿæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸš¨ åŒæ­¥è¿‡ç¨‹é‡åˆ°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼
            [æŸ¥çœ‹é”™è¯¯è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
