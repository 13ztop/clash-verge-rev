name: Auto Sync from clash-verge-rev/clash-verge-rev

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）自动同步
  workflow_dispatch:      # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # [其他步骤保持不变...]
      
      # 设置时区（上海时间）
      - name: Set Shanghai time
        id: set_time
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          CURRENT_TIME_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$CURRENT_TIME_SHORT" >> $GITHUB_ENV

      # 同步成功通知 (修复版)
      - name: Notify Telegram on Sync Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown  # 修复参数名
          message: |
            🔄 *Clash Verge Rev 同步报告 | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            ━━━━━━━━━━━━━━━━━━━━━━━━
            📦 **源仓库**: [clash-verge-rev/clash-verge-rev@${{ steps.source_version.outputs.commit_hash }}](https://github.com/clash-verge-rev/clash-verge-rev/commit/${{ steps.source_version.outputs.full_hash }})
            🏠 **目标仓库**: [13ztop/clash-verge-rev@${{ env.TARGET_COMMIT }} (${{ env.TARGET_BRANCH }})](https://github.com/13ztop/clash-verge-rev/tree/${{ env.TARGET_BRANCH }})
            ━━━━━━━━━━━━━━━━━━━━━━━━
            • **变更文件**: ${{ steps.commit_push.outputs.changes_count }} 个
            • **保留文件**: ${{ steps.find_protected.outputs.protected_files_count }} 个
            ${{ format('{0}', steps.source_version.outputs.tag != '无标签' && format('• **最新版本**: {0}', steps.source_version.outputs.tag) || '') }}
            • **同步时间**: ${{ env.CURRENT_TIME }}
            ━━━━━━━━━━━━━━━━━━━━━━━━
            ✅ 同步成功！仓库已更新
            [查看提交详情](https://github.com/13ztop/clash-verge-rev/commit/${{ github.sha }})

      # 无变更通知 (修复版)
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes_detected
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown  # 修复参数名
          message: |
            ℹ️ *Clash Verge Rev 同步报告 | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            ━━━━━━━━━━━━━━━━━━━━━━━━
            📦 **源仓库**: [clash-verge-rev/clash-verge-rev@${{ steps.source_version.outputs.commit_hash }}](https://github.com/clash-verge-rev/clash-verge-rev)
            🏠 **目标仓库**: [13ztop/clash-verge-rev@${{ env.TARGET_COMMIT }}](https://github.com/13ztop/clash-verge-rev)
            ━━━━━━━━━━━━━━━━━━━━━━━━
            • **保留文件**: ${{ steps.find_protected.outputs.protected_files_count }} 个
            ${{ format('{0}', steps.source_version.outputs.tag != '无标签' && format('• **当前版本**: {0}', steps.source_version.outputs.tag) || '') }}
            • **同步状态**: 内容一致，无需更新
            • **检测时间**: ${{ env.CURRENT_TIME }}
            ━━━━━━━━━━━━━━━━━━━━━━━━
            ✅ 仓库已是最新状态
            [查看仓库](https://github.com/13ztop/clash-verge-rev)

      # 同步失败通知 (修复版)
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown  # 修复参数名
          message: |
            ‼️ *Clash Verge Rev 同步失败 | ${{ env.CURRENT_TIME_SHORT }}*
            ━━━━━━━━━━━━━━━━━━━━━━━━
            🔧 **工作流**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ⏰ **发生时间**: ${{ env.CURRENT_TIME }}
            ━━━━━━━━━━━━━━━━━━━━━━━━
            🚨 同步过程遇到错误，请检查日志！
            [查看错误详情](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
