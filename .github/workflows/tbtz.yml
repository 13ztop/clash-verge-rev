name: Auto Sync from clash-verge-rev/clash-verge-rev

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: éªŒè¯æ‰€æœ‰å¿…è¦çš„ Secrets æ˜¯å¦å­˜åœ¨
      - name: Verify Secrets
        run: |
          # åˆ†åˆ«æ£€æŸ¥æ¯ä¸ªsecret
          if [ -z "${{ secrets.SYNC_TOKEN }}" ]; then
            echo "::error::SYNC_TOKENæœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "::error::TELEGRAM_BOT_TOKENæœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "::error::TELEGRAM_CHAT_IDæœªè®¾ç½®"
            exit 1
          fi
          
          echo "æ‰€æœ‰å¿…éœ€çš„Secretså·²è®¾ç½®"
          # å®‰å…¨åœ°æ˜¾ç¤ºéƒ¨åˆ†Tokenç”¨äºè°ƒè¯•
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          echo "BOT_TOKEN_PART=${BOT_TOKEN:0:2}****${BOT_TOKEN: -2}" >> $GITHUB_ENV
          echo "CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV

      # æ­¥éª¤ 2: è·å–ç›®æ ‡ä»“åº“çš„é»˜è®¤åˆ†æ”¯
      - name: Detect default branch
        id: branch_detector
        run: |
          echo "ä½¿ç”¨SYNC_TOKEN: ${SYNC_TOKEN:0:2}****${SYNC_TOKEN: -2}"
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
          "https://api.github.com/repos/13ztop/clash-verge-rev" | jq -r .default_branch)
          
          if [ -z "$DEFAULT_BRANCH" ] || [ "$DEFAULT_BRANCH" = "null" ]; then
            echo "::warning::æ— æ³•è·å–é»˜è®¤åˆ†æ”¯ï¼Œä½¿ç”¨å¤‡ç”¨åˆ†æ”¯'main'"
            DEFAULT_BRANCH="main"
          fi
          
          echo "Detected default branch: $DEFAULT_BRANCH"
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV

      # æ­¥éª¤ 3-14: [ä¿æŒä¸å˜]...

      # æ­¥éª¤ 15: è®¾ç½®æ—¶åŒºï¼ˆä¸Šæµ·æ—¶é—´ï¼‰
      - name: Set Shanghai time
        id: set_time
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          CURRENT_TIME_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$CURRENT_TIME_SHORT" >> $GITHUB_ENV

      # æ­¥éª¤ 16: è°ƒè¯•æ­¥éª¤ - æ˜¾ç¤ºå…³é”®ä¿¡æ¯
      - name: Debug Information
        run: |
          echo "===== è°ƒè¯•ä¿¡æ¯ ====="
          echo "å½“å‰æ—¶é—´: ${{ env.CURRENT_TIME }}"
          echo "BOT_TOKEN_PART: ${{ env.BOT_TOKEN_PART }}"
          echo "CHAT_ID: ${{ env.CHAT_ID }}"
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          echo "æºä»“åº“ç‰ˆæœ¬: ${{ steps.source_version.outputs.commit_hash }}"
          echo "ç›®æ ‡ä»“åº“ç‰ˆæœ¬: ${{ env.TARGET_COMMIT }}"
          echo "å˜æ›´æ–‡ä»¶æ•°: ${{ steps.commit_push.outputs.changes_count || '0' }}"
          echo "ä¿ç•™æ–‡ä»¶æ•°: ${{ steps.find_protected.outputs.protected_files_count || '0' }}"
          echo "===================="

      # æ­¥éª¤ 17: æœ€ç»ˆé€šçŸ¥ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: Final Telegram Notification
        if: always()  # å³ä½¿å¤±è´¥ä¹Ÿå‘é€
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            ${{ (success() && 'âœ…' || 'â€¼ï¸') }} *Clash Verge Rev åŒæ­¥æŠ¥å‘Š | ${{ env.CURRENT_TIME_SHORT }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **çŠ¶æ€**: ${{ (success() && 'æˆåŠŸ' || 'å¤±è´¥') }}
            â€¢ **å·¥ä½œæµ**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ **æºä»“åº“**: [clash-verge-rev@${{ steps.source_version.outputs.commit_hash }}](https://github.com/clash-verge-rev/clash-verge-rev/commit/${{ steps.source_version.outputs.full_hash }})
            â€¢ **ç›®æ ‡ä»“åº“**: [13ztop@${{ env.TARGET_COMMIT }}](https://github.com/13ztop/clash-verge-rev/commit/${{ github.sha }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ (steps.commit_push.outputs.changes_count != '0' && steps.commit_push.outputs.changes_count != '') && format('â€¢ **å˜æ›´æ–‡ä»¶**: {0}', steps.commit_push.outputs.changes_count) || '' }}
            â€¢ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_protected.outputs.protected_files_count || '0' }}
            â€¢ **ç‰ˆæœ¬**: ${{ steps.source_version.outputs.tag || 'æ— æ ‡ç­¾' }}
            â€¢ **è¿è¡Œæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ (success() && 'âœ… åŒæ­¥å·²å®Œæˆ\n[æŸ¥çœ‹æäº¤](' || 'ğŸš¨ åŒæ­¥è¿‡ç¨‹é‡åˆ°é”™è¯¯\n[æŸ¥çœ‹æ—¥å¿—](') }}${{ github.server_url }}/${{ github.repository }}/${{ (success() && 'commit/' || 'actions/runs/') }}${{ (success() && github.sha || github.run_id) }})
